
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Databases and Asynchronous ORMs &#8212; ğ—œğ—»ğ—²ğ—³ğ—³ğ—¶ğ—°ğ—¶ğ—²ğ—»ğ˜ ğ—¡ğ—²ğ˜ğ˜„ğ—¼ğ—¿ğ—¸ğ˜€</title>
    
  <link href="../../_static/css/theme.css" rel="stylesheet">
  <link href="../../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/togglebutton.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../_static/sphinx-book-theme.d59cb220de22ca1c485ebbdc042f0030.js"></script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script>
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="shortcut icon" href="../../_static/pone.0237978.g001.png"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../../_static/pone.0237978.g001.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">ğ—œğ—»ğ—²ğ—³ğ—³ğ—¶ğ—°ğ—¶ğ—²ğ—»ğ˜ ğ—¡ğ—²ğ˜ğ˜„ğ—¼ğ—¿ğ—¸ğ˜€</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  FUNDAMENTALS
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../notebooks/fundamentals/house-prices.html">
   Pipelines in
   <code class="docutils literal notranslate">
    <span class="pre">
     scikit-learn
    </span>
   </code>
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../notebooks/fundamentals/blending-stacking.html">
   Blending and Stacking
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../notebooks/fundamentals/optuna.html">
   Model Tuning with Optuna
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../notebooks/fundamentals/missing.html">
   Handling Missing Values
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  DEEP LEARNING
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../notebooks/fundamentals/backpropagation.html">
   Backpropagation on DAGs
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../notebooks/tensorflow/01-tensorflow-nn.html">
   TensorFlow Datasets
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../notebooks/tensorflow/02-tensorflow-mechanics.html">
   Mechanics of TensorFlow
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../notebooks/tensorflow/03-tensorflow-activations.html">
   Activation Functions
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../notebooks/tensorflow/04-tensorflow-optim-init.html">
   Initialization and Optimization
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  MODEL DEPLOYMENT
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../notebooks/deployment/production-code.html">
   Packaging Production Code
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../../_sources/drafts/fastapi/chapter6.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
                onclick="printPdf(this)" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/particle1331/inefficient-networks"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/particle1331/inefficient-networks/issues/new?title=Issue%20on%20page%20%2Fdrafts/fastapi/chapter6.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/particle1331/inefficient-networks/master?urlpath=tree/docs/drafts/fastapi/chapter6.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show noprint">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#an-overview-of-relational-databases">
   An overview of relational databases
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#communicating-with-a-sql-database-with-sqlalchemy">
   Communicating with a SQL database with SQLAlchemy
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#creating-the-table-schema">
     Creating the table schema
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#connecting-to-a-database">
     Connecting to a database
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#setting-up-connection">
       Setting up connection
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#startup-and-shutdown">
       Startup and shutdown
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#defining-dependencies">
     Defining dependencies
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#making-insert-queries">
     Making insert queries
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#making-select-queries">
     Making select queries
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#making-update-and-delete-queries">
     Making update and delete queries
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#adding-relationships">
     Adding relationships
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#setting-up-a-database-migration-system-with-alembic">
     Setting up a database migration system with Alembic
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#communicating-with-a-sql-database-with-tortoise-orm">
   Communicating with a SQL database with Tortoise ORM
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#creating-database-models">
     Creating database models
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#setting-up-the-tortoise-engine">
     Setting up the Tortoise engine
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#creating-objects">
     Creating objects
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#getting-and-filtering-objects">
     Getting and filtering objects
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#updating-and-deleting-objects">
     Updating and deleting objects
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id2">
     Adding relationships
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#setting-up-a-database-migration-system-with-aerich">
     Setting up a database migration system with Aerich
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#conclusion">
   Conclusion
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Databases and Asynchronous ORMs</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#an-overview-of-relational-databases">
   An overview of relational databases
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#communicating-with-a-sql-database-with-sqlalchemy">
   Communicating with a SQL database with SQLAlchemy
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#creating-the-table-schema">
     Creating the table schema
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#connecting-to-a-database">
     Connecting to a database
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#setting-up-connection">
       Setting up connection
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#startup-and-shutdown">
       Startup and shutdown
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#defining-dependencies">
     Defining dependencies
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#making-insert-queries">
     Making insert queries
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#making-select-queries">
     Making select queries
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#making-update-and-delete-queries">
     Making update and delete queries
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#adding-relationships">
     Adding relationships
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#setting-up-a-database-migration-system-with-alembic">
     Setting up a database migration system with Alembic
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#communicating-with-a-sql-database-with-tortoise-orm">
   Communicating with a SQL database with Tortoise ORM
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#creating-database-models">
     Creating database models
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#setting-up-the-tortoise-engine">
     Setting up the Tortoise engine
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#creating-objects">
     Creating objects
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#getting-and-filtering-objects">
     Getting and filtering objects
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#updating-and-deleting-objects">
     Updating and deleting objects
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id2">
     Adding relationships
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#setting-up-a-database-migration-system-with-aerich">
     Setting up a database migration system with Aerich
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#conclusion">
   Conclusion
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            
              <div>
                
  <div class="tex2jax_ignore mathjax_ignore section" id="databases-and-asynchronous-orms">
<h1>Databases and Asynchronous ORMs<a class="headerlink" href="#databases-and-asynchronous-orms" title="Permalink to this headline">Â¶</a></h1>
<div class="admonition-attribution admonition">
<p class="admonition-title">Attribution</p>
<p>This notebook follows Chapter 6: <em>Databases and Asynchronous ORMs</em> of <span id="id1">[<a class="reference internal" href="../../intro.html#id8">Vor21</a>]</span>. Source files for running the background local servers can be found <a class="reference external" href="https://github.com/particle1331/machine-learning/tree/master/docs/notebooks/fastapi/src/chapter6">here</a>.</p>
</div>
<p>The main goal of a REST API is, of course, to read and write data. So far, weâ€™ve solely
worked with the tools given by Python and FastAPI, allowing us to build reliable
endpoints to process and answer requests. However, we havenâ€™t been able to effectively
retrieve and persist that information: we missed a <strong>database</strong>.</p>
<p>In this notebook we will deal with interacting with databases and related libraries inside FastAPI. Note that FastAPI is completely agnostic regarding databases and leaves integration of any system to the developer. We will review three different approaches to integrate a database:
(1) using <strong>basic SQL queries</strong>, and (2) using <strong>Object-Relational Mapping</strong> (<strong>ORM</strong>).</p>
<div class="section" id="an-overview-of-relational-databases">
<h2>An overview of relational databases<a class="headerlink" href="#an-overview-of-relational-databases" title="Permalink to this headline">Â¶</a></h2>
<p>The role of a database is to store data in a structured way, preserve the integrity of the
data, and offer a query language that enables you to retrieve this data when an application
needs it. Relational databases implement the relational model: each entity, or object, of the
application is stored in <strong>tables</strong>. Each table has several <strong>columns</strong> containing attributes of the entity. One of the key points of relational databases is, as their name suggests, relationships. Each
table can be in relation to others, with rows referring to other rows in other tables.</p>
<p>The main motivation behind this is to avoid duplication. Indeed, it wouldnâ€™t be very
efficient to repeat an objectâ€™s attributes in each related to it. If it needs to be modified
at some point, we would have to go through each related entity, which is error-prone and puts data
consistency at risk. This is why we prefer to references to entities using unique identifiers.</p>
<p>To do this, each row in a relational database has an identifier, called a <strong>primary key</strong>. This is
unique in the table and will allow you to uniquely identify this row. Therefore, itâ€™s possible
to use this key in another table to reference it. We call it a <strong>foreign key</strong>: the key is foreign in
the sense that it refers to another table. Relational databases are designed to perform <strong>join queries</strong> efficiently, which will return all the relevant records
based on the foreign keys. However, those operations can become expensive if the schema is more complex. This is why itâ€™s important to carefully design a relational schema and its queries.</p>
</div>
<div class="section" id="communicating-with-a-sql-database-with-sqlalchemy">
<h2>Communicating with a SQL database with SQLAlchemy<a class="headerlink" href="#communicating-with-a-sql-database-with-sqlalchemy" title="Permalink to this headline">Â¶</a></h2>
<p>To begin, we will discuss how to work with a relational database using the SQLAlchemy
library. Note that we will only consider the core part of the library, which
only provides the tools to abstract communication with a SQL database. We wonâ€™t
consider the ORM part, as, in the next section, weâ€™ll focus on another ORM: Tortoise. We will combine SQLAlchemy with the <code class="docutils literal notranslate"><span class="pre">databases</span></code> library by Encode, the same team
behind Starlette, which provides an asynchronous connection layer for SQLAlchemy:</p>
<div class="figure align-default" id="sqlalch-encode">
<img alt="../../_images/sqlalch-encode.png" src="../../_images/sqlalch-encode.png" />
</div>
<div class="section" id="creating-the-table-schema">
<h3>Creating the table schema<a class="headerlink" href="#creating-the-table-schema" title="Permalink to this headline">Â¶</a></h3>
<p>First, you need to define the SQL schema for your tables: the name, the columns, and their
associated types and properties. In the following example, you can view the definition of the
<code class="docutils literal notranslate"><span class="pre">posts</span></code> table:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># chapter6/sqlalchemy/models.py</span>

<span class="n">metadata</span> <span class="o">=</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">MetaData</span><span class="p">()</span>
<span class="n">posts</span> <span class="o">=</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span>
    <span class="s2">&quot;posts&quot;</span><span class="p">,</span>
    <span class="n">metadata</span><span class="p">,</span>
    <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">autoincrement</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s2">&quot;publication_date&quot;</span><span class="p">,</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">DateTime</span><span class="p">(),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
    <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">255</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
    <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">,</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">Text</span><span class="p">(),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<span class="p">)</span>
</pre></div>
</div>
<p>First, we created a <code class="docutils literal notranslate"><span class="pre">metadata</span></code> object. Its role is to keep all the information of a database
schema together. This is why you should create it only once in your whole project and
always use the same one throughout.</p>
<p>Next, we defined a table using the <code class="docutils literal notranslate"><span class="pre">Table</span></code> class. The first argument is the name of the
table, followed by the metadata object. Then, we list all of the columns that should be
defined in our table, thanks to the <code class="docutils literal notranslate"><span class="pre">Column</span></code> class. The first argument is the name of the
column, followed by its <a class="reference external" href="https://docs.sqlalchemy.org/en/13/core/type_basics.html#generic-types">type</a> and <a class="reference external" href="https://docs.sqlalchemy.org/en/13/core/metadata.html#:~:text=sqlalchemy.schema.Column.__init__">some options</a>. For example, we define
our <code class="docutils literal notranslate"><span class="pre">id</span></code> column as a primary key with auto-increment, which is quite common in
a SQL database.</p>
<p>We will also define the
corresponding Pydantic models for our post entity in the same file. Since they will be used by FastAPI to
validate the request payload, they must match the SQL definition to avoid any errors from
the database when we try to insert a new row later.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># chapter6/sqlalchemy/models.py</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span>
<span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span>


<span class="k">class</span> <span class="nc">PostBase</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">title</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">content</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">publication_date</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">PostPartialUpdate</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">title</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">content</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>


<span class="k">class</span> <span class="nc">PostCreate</span><span class="p">(</span><span class="n">PostBase</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">PostDB</span><span class="p">(</span><span class="n">PostBase</span><span class="p">):</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span>
</pre></div>
</div>
</div>
<div class="section" id="connecting-to-a-database">
<h3>Connecting to a database<a class="headerlink" href="#connecting-to-a-database" title="Permalink to this headline">Â¶</a></h3>
<div class="section" id="setting-up-connection">
<h4>Setting up connection<a class="headerlink" href="#setting-up-connection" title="Permalink to this headline">Â¶</a></h4>
<p>Now that our table is ready, we have to set up the connection between our FastAPI app
and the database engine.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># chapter6/sqlalchemy/database.py</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">create_engine</span>
<span class="kn">from</span> <span class="nn">databases</span> <span class="kn">import</span> <span class="n">Database</span>


<span class="n">DATABASE_URL</span> <span class="o">=</span> <span class="s2">&quot;sqlite:///chapter6_sqlalchemy.db&quot;</span>
<span class="n">database</span> <span class="o">=</span> <span class="n">Database</span><span class="p">(</span><span class="n">DATABASE_URL</span><span class="p">)</span>
<span class="n">sqlalchemy_engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="n">DATABASE_URL</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_database</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Database</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">database</span>
</pre></div>
</div>
<p>Observe that we instantiate a <code class="docutils literal notranslate"><span class="pre">Database</span></code> instance using the database URL. This is the connection layer provided by <code class="docutils literal notranslate"><span class="pre">databases</span></code> that will allow us to perform asynchronous queries. Notice that the standard synchronous connection established in <code class="docutils literal notranslate"><span class="pre">sqlalchemy_engine</span></code> overlaps with <code class="docutils literal notranslate"><span class="pre">database</span></code>. The idea for this is that all our async endpoints will be using <code class="docutils literal notranslate"><span class="pre">databases</span></code>; we will only use <code class="docutils literal notranslate"><span class="pre">sqlalchemy_engine</span></code> once when creating the schema for our database.</p>
<p>The function <code class="docutils literal notranslate"><span class="pre">get_database</span></code> will be used as a dependency easily retrieve the database instance in our path operation functions. Setting up a dependency like this instead of directly importing objects will benefit us during automated testing.</p>
</div>
<div class="section" id="startup-and-shutdown">
<h4>Startup and shutdown<a class="headerlink" href="#startup-and-shutdown" title="Permalink to this headline">Â¶</a></h4>
<p>Now, we need to tell FastAPI to open the connection with the database when it starts
the application and then close it when exiting. FastAPI provides two
special decorators to perform tasks at startup and shutdown, as you can see in the
following example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># chapter6/sqlalchemy/app.py</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">on_event</span><span class="p">(</span><span class="s2">&quot;startup&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">startup</span><span class="p">():</span>
    <span class="k">await</span> <span class="n">database</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
    <span class="n">metadata</span><span class="o">.</span><span class="n">create_all</span><span class="p">(</span><span class="n">sqlalchemy_engine</span><span class="p">)</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">on_event</span><span class="p">(</span><span class="s2">&quot;shutdown&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">shutdown</span><span class="p">():</span>
    <span class="k">await</span> <span class="n">database</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>
</pre></div>
</div>
<p>Additionally, you can see that we call the <code class="docutils literal notranslate"><span class="pre">create_all</span></code> method on the <code class="docutils literal notranslate"><span class="pre">metadata</span></code> object. This is the same <code class="docutils literal notranslate"><span class="pre">metadata</span></code> object we defined in the previous section and that we have
imported here. The goal of this method is to create the tableâ€™s schema inside our database.
Otherwise, our database would be empty and we would not be able to save
or retrieve data. This method is designed to work with a standard SQLAlchemy engine;
this is why we instantiated <code class="docutils literal notranslate"><span class="pre">sqlalchemy_engine</span></code> earlier. It has no other use in the application; instead, we will be using <code class="docutils literal notranslate"><span class="pre">database</span></code> which works with our async endpoints.</p>
</div>
</div>
<div class="section" id="defining-dependencies">
<h3>Defining dependencies<a class="headerlink" href="#defining-dependencies" title="Permalink to this headline">Â¶</a></h3>
<p>We will define two dependencies. Recall that dependency logic are injected in endpoint calls which allows them to use other arguments of the endpoints whose values may also be obtained through a dependency injection.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># chapter6/sqlalchemy/app.py</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">get_post_or_404</span><span class="p">(</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">database</span><span class="p">:</span> <span class="n">Database</span><span class="o">=</span><span class="n">Depends</span><span class="p">(</span><span class="n">get_database</span><span class="p">)</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PostDB</span><span class="p">:</span>

    <span class="n">select_query</span> <span class="o">=</span> <span class="n">posts</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">posts</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="nb">id</span><span class="p">)</span> <span class="c1"># overloaded</span>
    <span class="n">raw_post</span> <span class="o">=</span> <span class="k">await</span> <span class="n">database</span><span class="o">.</span><span class="n">fetch_one</span><span class="p">(</span><span class="n">select_query</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">raw_post</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">PostDB</span><span class="p">(</span><span class="o">**</span><span class="n">raw_post</span><span class="p">)</span> <span class="c1"># raw_post is of type dict</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">pagination</span><span class="p">(</span>
    <span class="n">skip</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="n">Query</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="n">Query</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
    
    <span class="n">capped_limit</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">limit</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">skip</span><span class="p">,</span> <span class="n">capped_limit</span><span class="p">)</span>
</pre></div>
</div>
<p>Note that chained method calls are automatically transformed into SQL statements in <code class="docutils literal notranslate"><span class="pre">select_query</span></code>. Moreover, the equality operator in <code class="docutils literal notranslate"><span class="pre">posts.c.id</span> <span class="pre">==</span> <span class="pre">id</span></code> is not merely a Boolean statement but is overloaded to work with SQLAlchemy method calls. A more thorough discussion of chained method calls is presented in the following subsection.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">chapter6.sqlalchemy.models</span> <span class="kn">import</span> <span class="n">posts</span>
<span class="n">posts</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="mi">1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;sqlalchemy.sql.elements.BinaryExpression object at 0x1081285e0&gt;
</pre></div>
</div>
</div>
</div>
<p>Finally, observe that we have to use <code class="docutils literal notranslate"><span class="pre">await</span></code> which tells the interpreter that the async method canâ€™t continue past that point â€” blocked â€” until the awaited asynchronous process is finished.</p>
</div>
<div class="section" id="making-insert-queries">
<h3>Making insert queries<a class="headerlink" href="#making-insert-queries" title="Permalink to this headline">Â¶</a></h3>
<p>Now weâ€™re ready to make queries! Letâ€™s start with the INSERT queries to create new rows
in our database. In the following example, you can view an implementation of an endpoint
to create a new post:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># sqlalchemy/app.py</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/posts&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">PostDB</span><span class="p">,</span> <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_201_CREATED</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">create_post</span><span class="p">(</span>
    <span class="n">post</span><span class="p">:</span> <span class="n">PostCreate</span><span class="p">,</span> 
    <span class="n">database</span><span class="p">:</span> <span class="n">Database</span><span class="o">=</span><span class="n">Depends</span><span class="p">(</span><span class="n">get_database</span><span class="p">)</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PostDB</span><span class="p">:</span>
    
    <span class="n">insert_query</span> <span class="o">=</span> <span class="n">posts</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">post</span><span class="o">.</span><span class="n">dict</span><span class="p">())</span>
    <span class="n">post_id</span> <span class="o">=</span> <span class="k">await</span> <span class="n">database</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">insert_query</span><span class="p">)</span>
    <span class="n">post_db</span> <span class="o">=</span> <span class="k">await</span> <span class="n">get_post_or_404</span><span class="p">(</span><span class="n">post_id</span><span class="p">,</span> <span class="n">database</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">post_db</span>
</pre></div>
</div>
<p>This is a POST endpoint that accepts a payload following the <code class="docutils literal notranslate"><span class="pre">PostCreate</span></code> model. It also injects the database thanks to our <code class="docutils literal notranslate"><span class="pre">get_database</span></code> dependency. Interesting things begin in the body of the function:</p>
<ul class="simple">
<li><p>On the first line, we build our INSERT query. Rather than writing SQL queries by hand, we rely on the SQLAlchemy expression language, which consists of <strong>chained method calls</strong>. Under the hood, SQLAlchemy will build a proper SQL query for our database engine. This is one of the greatest benefits of such libraries: since it produces the SQL query for you, you wonâ€™t have to modify your source code if you change your database engine.</p></li>
</ul>
<ul class="simple">
<li><p>This query is built directly from the posts object, which is the <code class="docutils literal notranslate"><span class="pre">Table</span></code> instance that
we defined earlier. By using this object, SQLAlchemy directly understands that the
query concerns this table and builds the SQL accordingly. We start by calling the <code class="docutils literal notranslate"><span class="pre">insert</span></code> method. Then, we move ahead with the <code class="docutils literal notranslate"><span class="pre">values</span></code>
method. This simply accepts a dictionary that associates the names of the columns
with their values. Hence, we just need to call <code class="docutils literal notranslate"><span class="pre">dict()</span></code> on our Pydantic object. This
is why itâ€™s important that our model matches the database schema.</p></li>
</ul>
<ul class="simple">
<li><p>On the second line, weâ€™ll actually perform the query. Thanks to <code class="docutils literal notranslate"><span class="pre">database</span></code>, we can
execute it asynchronously. For an insert query, weâ€™ll use the <code class="docutils literal notranslate"><span class="pre">execute</span></code> method,
which expects the query in an argument.</p></li>
</ul>
<p>An INSERT query will return the primary key (here <code class="docutils literal notranslate"><span class="pre">id</span></code>) of the newly inserted row. This is very important
because, since we allow the database to automatically increment this identifier, we donâ€™t
know the <code class="docutils literal notranslate"><span class="pre">id</span></code> of our new post beforehand. In fact, we need it to retrieve this new row from the database afterward. By doing this, we ensure we have an exact representation of the current object in the database before
returning it in the response. For this, we use the <code class="docutils literal notranslate"><span class="pre">get_post_or_404</span></code> dependency defined above.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>http POST :8000/posts <span class="nv">title</span><span class="o">=</span><span class="s2">&quot;Title #1&quot;</span> <span class="nv">content</span><span class="o">=</span><span class="s2">&quot;Content #1&quot;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Blue">HTTP</span>/<span class=" -Color -Color-Blue">1.1</span> <span class=" -Color -Color-Blue">201</span> <span class=" -Color -Color-Cyan">Created</span>
<span class=" -Color -Color-Cyan">content-length</span>: 98
<span class=" -Color -Color-Cyan">content-type</span>: application/json
<span class=" -Color -Color-Cyan">date</span>: Sun, 06 Mar 2022 07:13:02 GMT
<span class=" -Color -Color-Cyan">server</span>: uvicorn

{
<span class=" -Color -Color-White">    </span>&quot;content&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Yellow">&quot;Content #1&quot;</span>,
<span class=" -Color -Color-White">    </span>&quot;id&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Blue">1</span>,
<span class=" -Color -Color-White">    </span>&quot;publication_date&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Yellow">&quot;2022-03-06T15:13:02.889509&quot;</span>,
<span class=" -Color -Color-White">    </span>&quot;title&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Yellow">&quot;Title #1&quot;</span>
}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>http POST :8000/posts <span class="nv">title</span><span class="o">=</span><span class="s2">&quot;Title #2&quot;</span> <span class="nv">content</span><span class="o">=</span><span class="s2">&quot;Content #2&quot;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Blue">HTTP</span>/<span class=" -Color -Color-Blue">1.1</span> <span class=" -Color -Color-Blue">201</span> <span class=" -Color -Color-Cyan">Created</span>
<span class=" -Color -Color-Cyan">content-length</span>: 98
<span class=" -Color -Color-Cyan">content-type</span>: application/json
<span class=" -Color -Color-Cyan">date</span>: Sun, 06 Mar 2022 07:13:10 GMT
<span class=" -Color -Color-Cyan">server</span>: uvicorn

{
<span class=" -Color -Color-White">    </span>&quot;content&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Yellow">&quot;Content #2&quot;</span>,
<span class=" -Color -Color-White">    </span>&quot;id&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Blue">2</span>,
<span class=" -Color -Color-White">    </span>&quot;publication_date&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Yellow">&quot;2022-03-06T15:13:11.119578&quot;</span>,
<span class=" -Color -Color-White">    </span>&quot;title&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Yellow">&quot;Title #2&quot;</span>
}
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="making-select-queries">
<h3>Making select queries<a class="headerlink" href="#making-select-queries" title="Permalink to this headline">Â¶</a></h3>
<p>Now that we can insert new data into our database, we must be able to read it! Typically,
youâ€™ll have two kinds of read endpoints in your API: one to list objects and one to get
a single object.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/posts/</span><span class="si">{id}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">PostDB</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">get_post</span><span class="p">(</span><span class="n">post</span><span class="p">:</span> <span class="n">PostDB</span><span class="o">=</span><span class="n">Depends</span><span class="p">(</span><span class="n">get_post_or_404</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="n">PostDB</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">post</span>
</pre></div>
</div>
<p>Recall that <code class="docutils literal notranslate"><span class="pre">get_post_or_404</span></code> has a SELECT statement inside it which is why we only need to inject that dependency and return its result. To get the list of all posts, we define the following endpoint which depends on <code class="docutils literal notranslate"><span class="pre">pagination</span></code> for offsets and limits.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># chapter6/sqlalchemy/app.py</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/posts&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">list_posts</span><span class="p">(</span>
    <span class="n">pagination</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span><span class="o">=</span><span class="n">Depends</span><span class="p">(</span><span class="n">pagination</span><span class="p">),</span> 
    <span class="n">database</span><span class="p">:</span> <span class="n">Database</span><span class="o">=</span><span class="n">Depends</span><span class="p">(</span><span class="n">get_database</span><span class="p">)</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">PostDB</span><span class="p">]:</span>

    <span class="n">skip</span><span class="p">,</span> <span class="n">limit</span> <span class="o">=</span> <span class="n">pagination</span>
    <span class="n">select_query</span> <span class="o">=</span> <span class="n">posts</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">offset</span><span class="p">(</span><span class="n">skip</span><span class="p">)</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="n">limit</span><span class="p">)</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="k">await</span> <span class="n">database</span><span class="o">.</span><span class="n">fetch_all</span><span class="p">(</span><span class="n">select_query</span><span class="p">)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">PostDB</span><span class="p">(</span><span class="o">**</span><span class="n">row</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">]</span>
    
    <span class="k">return</span> <span class="n">results</span>
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>http GET :8000/posts/1
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Blue">HTTP</span>/<span class=" -Color -Color-Blue">1.1</span> <span class=" -Color -Color-Blue">200</span> <span class=" -Color -Color-Cyan">OK</span>
<span class=" -Color -Color-Cyan">content-length</span>: 98
<span class=" -Color -Color-Cyan">content-type</span>: application/json
<span class=" -Color -Color-Cyan">date</span>: Sun, 06 Mar 2022 07:13:17 GMT
<span class=" -Color -Color-Cyan">server</span>: uvicorn

{
<span class=" -Color -Color-White">    </span>&quot;content&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Yellow">&quot;Content #1&quot;</span>,
<span class=" -Color -Color-White">    </span>&quot;id&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Blue">1</span>,
<span class=" -Color -Color-White">    </span>&quot;publication_date&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Yellow">&quot;2022-03-06T15:13:02.889509&quot;</span>,
<span class=" -Color -Color-White">    </span>&quot;title&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Yellow">&quot;Title #1&quot;</span>
}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>http GET :8000/posts
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Blue">HTTP</span>/<span class=" -Color -Color-Blue">1.1</span> <span class=" -Color -Color-Blue">200</span> <span class=" -Color -Color-Cyan">OK</span>
<span class=" -Color -Color-Cyan">content-length</span>: 199
<span class=" -Color -Color-Cyan">content-type</span>: application/json
<span class=" -Color -Color-Cyan">date</span>: Sun, 06 Mar 2022 07:13:18 GMT
<span class=" -Color -Color-Cyan">server</span>: uvicorn

[
<span class=" -Color -Color-White">    </span>{
<span class=" -Color -Color-White">        </span>&quot;content&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Yellow">&quot;Content #1&quot;</span>,
<span class=" -Color -Color-White">        </span>&quot;id&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Blue">1</span>,
<span class=" -Color -Color-White">        </span>&quot;publication_date&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Yellow">&quot;2022-03-06T15:13:02.889509&quot;</span>,
<span class=" -Color -Color-White">        </span>&quot;title&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Yellow">&quot;Title #1&quot;</span>
<span class=" -Color -Color-White">    </span>},
<span class=" -Color -Color-White">    </span>{
<span class=" -Color -Color-White">        </span>&quot;content&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Yellow">&quot;Content #2&quot;</span>,
<span class=" -Color -Color-White">        </span>&quot;id&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Blue">2</span>,
<span class=" -Color -Color-White">        </span>&quot;publication_date&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Yellow">&quot;2022-03-06T15:13:11.119578&quot;</span>,
<span class=" -Color -Color-White">        </span>&quot;title&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Yellow">&quot;Title #2&quot;</span>
<span class=" -Color -Color-White">    </span>}
]
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="making-update-and-delete-queries">
<h3>Making update and delete queries<a class="headerlink" href="#making-update-and-delete-queries" title="Permalink to this headline">Â¶</a></h3>
<p>Finally, letâ€™s examine how to update and delete rows in our database. The main
difference is how you build the query using SQLAlchemy expressions, but the rest of the
implementation is always the same: (1) <strong>build query</strong>, (2) <strong>execute</strong>, and (3) return the <strong>response</strong>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># chapter6/sqlalchemy/app.py</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s2">&quot;/posts/</span><span class="si">{id}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">PostDB</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">update_post</span><span class="p">(</span>
    <span class="n">post_update</span><span class="p">:</span> <span class="n">PostPartialUpdate</span><span class="p">,</span>
    <span class="n">post</span><span class="p">:</span> <span class="n">PostDB</span><span class="o">=</span><span class="n">Depends</span><span class="p">(</span><span class="n">get_post_or_404</span><span class="p">),</span>
    <span class="n">database</span><span class="p">:</span> <span class="n">Database</span><span class="o">=</span><span class="n">Depends</span><span class="p">(</span><span class="n">get_database</span><span class="p">)</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PostDB</span><span class="p">:</span>

    <span class="n">update_query</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">posts</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
        <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">posts</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">post</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>                 <span class="c1"># match post in db</span>
        <span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">post_update</span><span class="o">.</span><span class="n">dict</span><span class="p">(</span><span class="n">exclude_unset</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span> <span class="c1"># set update values</span>
    <span class="p">)</span>

    <span class="n">post_id</span> <span class="o">=</span> <span class="k">await</span> <span class="n">database</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">update_query</span><span class="p">)</span>
    <span class="n">post_db</span> <span class="o">=</span> <span class="k">await</span> <span class="n">get_post_or_404</span><span class="p">(</span><span class="n">post_id</span><span class="p">,</span> <span class="n">database</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">post_db</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s2">&quot;/posts/</span><span class="si">{id}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_204_NO_CONTENT</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">delete_post</span><span class="p">(</span>
    <span class="n">post</span><span class="p">:</span> <span class="n">PostDB</span><span class="o">=</span><span class="n">Depends</span><span class="p">(</span><span class="n">get_post_or_404</span><span class="p">),</span>
    <span class="n">database</span><span class="p">:</span> <span class="n">Database</span><span class="o">=</span><span class="n">Depends</span><span class="p">(</span><span class="n">get_database</span><span class="p">)</span>
<span class="p">):</span>
    <span class="n">delete_query</span> <span class="o">=</span> <span class="n">posts</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">posts</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">post</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="c1"># match post to delete</span>
    <span class="k">await</span> <span class="n">database</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">delete_query</span><span class="p">)</span>
</pre></div>
</div>
<p>Letâ€™s test these with the existing posts:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>http PATCH :8000/posts/1 <span class="nv">title</span><span class="o">=</span><span class="s2">&quot;New Title #1&quot;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Blue">HTTP</span>/<span class=" -Color -Color-Blue">1.1</span> <span class=" -Color -Color-Blue">200</span> <span class=" -Color -Color-Cyan">OK</span>
<span class=" -Color -Color-Cyan">content-length</span>: 102
<span class=" -Color -Color-Cyan">content-type</span>: application/json
<span class=" -Color -Color-Cyan">date</span>: Sun, 06 Mar 2022 07:13:24 GMT
<span class=" -Color -Color-Cyan">server</span>: uvicorn

{
<span class=" -Color -Color-White">    </span>&quot;content&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Yellow">&quot;Content #1&quot;</span>,
<span class=" -Color -Color-White">    </span>&quot;id&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Blue">1</span>,
<span class=" -Color -Color-White">    </span>&quot;publication_date&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Yellow">&quot;2022-03-06T15:13:02.889509&quot;</span>,
<span class=" -Color -Color-White">    </span>&quot;title&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Yellow">&quot;New Title #1&quot;</span>
}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>http DELETE :8000/posts/2
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Blue">HTTP</span>/<span class=" -Color -Color-Blue">1.1</span> <span class=" -Color -Color-Blue">204</span> <span class=" -Color -Color-Cyan">No Content</span>
<span class=" -Color -Color-Cyan">content-length</span>: 4
<span class=" -Color -Color-Cyan">content-type</span>: application/json
<span class=" -Color -Color-Cyan">date</span>: Sun, 06 Mar 2022 07:13:24 GMT
<span class=" -Color -Color-Cyan">server</span>: uvicorn


</pre></div>
</div>
</div>
</div>
<p>Select all posts:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>http :8000/posts
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Blue">HTTP</span>/<span class=" -Color -Color-Blue">1.1</span> <span class=" -Color -Color-Blue">200</span> <span class=" -Color -Color-Cyan">OK</span>
<span class=" -Color -Color-Cyan">content-length</span>: 104
<span class=" -Color -Color-Cyan">content-type</span>: application/json
<span class=" -Color -Color-Cyan">date</span>: Sun, 06 Mar 2022 07:13:26 GMT
<span class=" -Color -Color-Cyan">server</span>: uvicorn

[
<span class=" -Color -Color-White">    </span>{
<span class=" -Color -Color-White">        </span>&quot;content&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Yellow">&quot;Content #1&quot;</span>,
<span class=" -Color -Color-White">        </span>&quot;id&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Blue">1</span>,
<span class=" -Color -Color-White">        </span>&quot;publication_date&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Yellow">&quot;2022-03-06T15:13:02.889509&quot;</span>,
<span class=" -Color -Color-White">        </span>&quot;title&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Yellow">&quot;New Title #1&quot;</span>
<span class=" -Color -Color-White">    </span>}
]
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="adding-relationships">
<h3>Adding relationships<a class="headerlink" href="#adding-relationships" title="Permalink to this headline">Â¶</a></h3>
<p>Quite often, youâ€™ll need to create entities that are linked to others.
For example, comments are linked to the post they relate to. In this
section, weâ€™ll examine how you can set up such relationships with SQLAlchemy. First, we need to define the table for the comments, which has a foreign key toward the
posts table. You can view its definition in the following example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># chapter6/sqlalchemy_relationship/models.py</span>

<span class="n">comments</span> <span class="o">=</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span>
    <span class="s2">&quot;comments&quot;</span><span class="p">,</span>
    <span class="n">metadata</span><span class="p">,</span>
    <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">autoincrement</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s2">&quot;post_id&quot;</span><span class="p">,</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;posts.id&quot;</span><span class="p">,</span> <span class="n">ondelete</span><span class="o">=</span><span class="s2">&quot;CASCADE&quot;</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
    <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s2">&quot;publication_date&quot;</span><span class="p">,</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">DateTime</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
    <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">,</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">Text</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
<p>The important point here is the <code class="docutils literal notranslate"><span class="pre">post_id</span></code> column, which is of the <code class="docutils literal notranslate"><span class="pre">ForeignKey</span></code> type.
This is a special type that tells SQLAlchemy to automatically handle the type of the
column and the associated constraint. We simply have to give the table and column name
it refers to. Note that we can also specify the ON DELETE action. Here we choose <code class="docutils literal notranslate"><span class="pre">&quot;CASCADE&quot;</span></code> which means that all comments will be deleted once the parent post is deleted.</p>
<p>Here we define Pydantic models for the comments which are quite
straightforward. Note that <code class="docutils literal notranslate"><span class="pre">post_id</span></code> is specified in the comments base class, along with publication date and content. However, we want to highlight a new model we created <code class="docutils literal notranslate"><span class="pre">PostPublic</span></code> for the posts. This is shown in the following example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># chapter6/sqlalchemy_relationship/models.py</span>

<span class="k">class</span> <span class="nc">CommentBase</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">post_id</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">content</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">publication_date</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">CommentDB</span><span class="p">(</span><span class="n">CommentBase</span><span class="p">):</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span>


<span class="k">class</span> <span class="nc">CommentCreate</span><span class="p">(</span><span class="n">CommentBase</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">PostPublic</span><span class="p">(</span><span class="n">PostDB</span><span class="p">):</span>
    <span class="n">comments</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">CommentDB</span><span class="p">]</span>
</pre></div>
</div>
<p>In a REST API, there are some cases where it makes sense to automatically
retrieve the associated objects of an entity. Here, itâ€™ll be convenient to get the comments
of a post in a single request. Weâ€™ll use this model when getting a single post to serialize the
comments along with the post data.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># chapter6/sqlalchemy_relationship/app.py</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/comments&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">CommentDB</span><span class="p">,</span> <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_201_CREATED</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">create_comment</span><span class="p">(</span>
    <span class="n">comment</span><span class="p">:</span> <span class="n">CommentCreate</span><span class="p">,</span>
    <span class="n">database</span><span class="p">:</span> <span class="n">Database</span><span class="o">=</span><span class="n">Depends</span><span class="p">(</span><span class="n">get_database</span><span class="p">),</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CommentDB</span><span class="p">:</span>

    <span class="c1"># First, we must make sure posts exist before making comment</span>
    <span class="n">select_post_query</span> <span class="o">=</span> <span class="n">posts</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">posts</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">comment</span><span class="o">.</span><span class="n">post_id</span><span class="p">)</span>
    <span class="n">post</span> <span class="o">=</span> <span class="k">await</span> <span class="n">database</span><span class="o">.</span><span class="n">fetch_one</span><span class="p">(</span><span class="n">select_post_query</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">post</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">,</span> 
            <span class="n">detail</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Post </span><span class="si">{</span><span class="n">comment</span><span class="o">.</span><span class="n">post_id</span><span class="si">}</span><span class="s2"> does not exist.&quot;</span>
        <span class="p">)</span>
    
    <span class="c1"># Now, create comment in the database</span>
    <span class="n">insert_query</span> <span class="o">=</span> <span class="n">comments</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">comment</span><span class="o">.</span><span class="n">dict</span><span class="p">())</span>
    <span class="n">comment_id</span> <span class="o">=</span> <span class="k">await</span> <span class="n">database</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">insert_query</span><span class="p">)</span>

    <span class="c1"># Build the endpoint response</span>
    <span class="n">select_query</span> <span class="o">=</span> <span class="n">comments</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">comments</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">comment_id</span><span class="p">)</span>
    <span class="n">raw_comment</span> <span class="o">=</span> <span class="k">await</span> <span class="n">database</span><span class="o">.</span><span class="n">fetch_one</span><span class="p">(</span><span class="n">select_query</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">CommentDB</span><span class="p">(</span><span class="o">**</span><span class="n">raw_comment</span><span class="p">)</span>
</pre></div>
</div>
<p>Earlier, we mentioned that we wanted to retrieve a post and its comments at the same
time. To do this, weâ€™ll have to make a second query to retrieve the comments and then
merge all the data together in a <code class="docutils literal notranslate"><span class="pre">PostPublic</span></code> instance. We added this logic in the
<code class="docutils literal notranslate"><span class="pre">get_post_or_404</span></code> dependency, as you can see in the following example. Note we change the output type to <code class="docutils literal notranslate"><span class="pre">PostPublic</span></code> from <code class="docutils literal notranslate"><span class="pre">PostDB</span></code>. Note that this one change influences all other GET endpoints, though we still have to change the responses of the other endpoints to <code class="docutils literal notranslate"><span class="pre">PostPublic</span></code> to show the comments list.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># chapter6/sqlalchemy_relationship/app.py</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">get_post_or_404</span><span class="p">(</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">database</span><span class="p">:</span> <span class="n">Database</span><span class="o">=</span><span class="n">Depends</span><span class="p">(</span><span class="n">get_database</span><span class="p">)</span> 
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PostPublic</span><span class="p">:</span>

    <span class="n">select_query</span> <span class="o">=</span> <span class="n">posts</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">posts</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="nb">id</span><span class="p">)</span> <span class="c1"># overloaded</span>
    <span class="n">raw_post</span> <span class="o">=</span> <span class="k">await</span> <span class="n">database</span><span class="o">.</span><span class="n">fetch_one</span><span class="p">(</span><span class="n">select_query</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">raw_post</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span><span class="p">)</span>

    <span class="c1"># Here we add querying all comments for the post</span>
    <span class="n">select_post_comments_query</span> <span class="o">=</span> <span class="n">comments</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">comments</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">post_id</span> <span class="o">==</span> <span class="nb">id</span><span class="p">)</span>
    <span class="n">raw_comments</span> <span class="o">=</span> <span class="k">await</span> <span class="n">database</span><span class="o">.</span><span class="n">fetch_all</span><span class="p">(</span><span class="n">select_post_comments_query</span><span class="p">)</span> <span class="c1"># list</span>
    <span class="n">comments_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">CommentDB</span><span class="p">(</span><span class="o">**</span><span class="n">comment</span><span class="p">)</span> <span class="k">for</span> <span class="n">comment</span> <span class="ow">in</span> <span class="n">raw_comments</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">PostPublic</span><span class="p">(</span><span class="o">**</span><span class="n">raw_post</span><span class="p">,</span> <span class="n">comments</span><span class="o">=</span><span class="n">comments_list</span><span class="p">)</span>
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>http POST :8000/posts <span class="nv">title</span><span class="o">=</span><span class="s2">&quot;Title #1&quot;</span> <span class="nv">content</span><span class="o">=</span><span class="s2">&quot;Content #1&quot;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Blue">HTTP</span>/<span class=" -Color -Color-Blue">1.1</span> <span class=" -Color -Color-Blue">201</span> <span class=" -Color -Color-Cyan">Created</span>
<span class=" -Color -Color-Cyan">content-length</span>: 98
<span class=" -Color -Color-Cyan">content-type</span>: application/json
<span class=" -Color -Color-Cyan">date</span>: Sun, 06 Mar 2022 09:00:12 GMT
<span class=" -Color -Color-Cyan">server</span>: uvicorn

{
<span class=" -Color -Color-White">    </span>&quot;content&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Yellow">&quot;Content #1&quot;</span>,
<span class=" -Color -Color-White">    </span>&quot;id&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Blue">1</span>,
<span class=" -Color -Color-White">    </span>&quot;publication_date&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Yellow">&quot;2022-03-06T17:00:12.826138&quot;</span>,
<span class=" -Color -Color-White">    </span>&quot;title&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Yellow">&quot;Title #1&quot;</span>
}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>http POST :8000/comments <span class="nv">post_id</span><span class="o">=</span><span class="m">1</span> <span class="nv">content</span><span class="o">=</span><span class="s2">&quot;Comment for Post #1.&quot;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Blue">HTTP</span>/<span class=" -Color -Color-Blue">1.1</span> <span class=" -Color -Color-Blue">201</span> <span class=" -Color -Color-Cyan">Created</span>
<span class=" -Color -Color-Cyan">content-length</span>: 101
<span class=" -Color -Color-Cyan">content-type</span>: application/json
<span class=" -Color -Color-Cyan">date</span>: Sun, 06 Mar 2022 09:00:54 GMT
<span class=" -Color -Color-Cyan">server</span>: uvicorn

{
<span class=" -Color -Color-White">    </span>&quot;content&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Yellow">&quot;Comment for Post #1.&quot;</span>,
<span class=" -Color -Color-White">    </span>&quot;id&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Blue">1</span>,
<span class=" -Color -Color-White">    </span>&quot;post_id&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Blue">1</span>,
<span class=" -Color -Color-White">    </span>&quot;publication_date&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Yellow">&quot;2022-03-06T17:00:54.174116&quot;</span>
}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>http GET :8000/posts/1
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Blue">HTTP</span>/<span class=" -Color -Color-Blue">1.1</span> <span class=" -Color -Color-Blue">200</span> <span class=" -Color -Color-Cyan">OK</span>
<span class=" -Color -Color-Cyan">content-length</span>: 213
<span class=" -Color -Color-Cyan">content-type</span>: application/json
<span class=" -Color -Color-Cyan">date</span>: Sun, 06 Mar 2022 09:01:08 GMT
<span class=" -Color -Color-Cyan">server</span>: uvicorn

{
<span class=" -Color -Color-White">    </span>&quot;comments&quot;:<span class=" -Color -Color-White"> </span>[
<span class=" -Color -Color-White">        </span>{
<span class=" -Color -Color-White">            </span>&quot;content&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Yellow">&quot;Comment for Post #1.&quot;</span>,
<span class=" -Color -Color-White">            </span>&quot;id&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Blue">1</span>,
<span class=" -Color -Color-White">            </span>&quot;post_id&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Blue">1</span>,
<span class=" -Color -Color-White">            </span>&quot;publication_date&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Yellow">&quot;2022-03-06T17:00:54.174116&quot;</span>
<span class=" -Color -Color-White">        </span>}
<span class=" -Color -Color-White">    </span>],
<span class=" -Color -Color-White">    </span>&quot;content&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Yellow">&quot;Content #1&quot;</span>,
<span class=" -Color -Color-White">    </span>&quot;id&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Blue">1</span>,
<span class=" -Color -Color-White">    </span>&quot;publication_date&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Yellow">&quot;2022-03-06T17:00:12.826138&quot;</span>,
<span class=" -Color -Color-White">    </span>&quot;title&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Yellow">&quot;Title #1&quot;</span>
}
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="setting-up-a-database-migration-system-with-alembic">
<h3>Setting up a database migration system with Alembic<a class="headerlink" href="#setting-up-a-database-migration-system-with-alembic" title="Permalink to this headline">Â¶</a></h3>
<p>When developing an application, youâ€™ll likely make changes to your database schema to
add new tables, add new columns, or modify existing ones. Of course, if your application
is already in production, you donâ€™t want to erase all your data to recreate the schema from
scratch: you want them to be migrated to the new schema. Tools for this task have been
developed, and in this section, weâ€™ll learn how to set up Alembic, from the creators of
SQLAlchemy.</p>
<p>When starting a new project, the first thing to do is to initialize
the migration environment, which includes a set of files and directories where Alembic
will store its configuration and migration files. At the root of your project, run the
following command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ alembic init alembic
</pre></div>
</div>
<p>Note that it created an <code class="docutils literal notranslate"><span class="pre">alembic.ini</span></code> file, which contains all the
configuration options of Alembic. Weâ€™ll review two important settings of this file:
<code class="docutils literal notranslate"><span class="pre">script_location</span></code> and <code class="docutils literal notranslate"><span class="pre">sqlalchemy.url</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># chapter6/sqlalchemy_relationship/alembic.ini</span>

<span class="n">script_location</span> <span class="o">=</span> <span class="n">alembic</span>
<span class="n">sqlalchemy</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">sqlite</span><span class="p">:</span><span class="o">///</span><span class="n">chapter6_sqlalchemy</span><span class="o">.</span><span class="n">db</span>
</pre></div>
</div>
<p>Next, weâ€™ll focus on the <code class="docutils literal notranslate"><span class="pre">env.py</span></code> file. This is a Python script containing all the logic
executed by Alembic to initialize the migration engine and execute the migrations. Being
a Python script allows us to finely customize the execution of Alembic. For the time being,
weâ€™ll keep the default one except for one thing: weâ€™ll import our metadata object.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># chapter6/sqlalchemy_relationship/alembic/env.py</span>

<span class="n">target_metadata</span> <span class="o">=</span> <span class="n">metadata</span>
</pre></div>
</div>
<p>We provide the metadata object, which contains all table definitions, so the migration system will be able to automatically generate the migration scripts just
by looking at your schema! This way, you wonâ€™t have to write them from scratch.
When you have made changes to your database schema, you can run the following
command to generate a new migration script:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ alembic revision --autogenerate -m &quot;Initial migration&quot;
</pre></div>
</div>
<div class="margin sidebar">
<p class="sidebar-title"></p>
<p>âš ï¸ You should be extremely careful when you run such commands on
your database, especially on a production one. Very bad things can happen if you make
a mistake, and you can lose precious data. Always test your migrations in
a test environment and have fresh and working backups before running them on your
production database.</p>
</div>
<p>Itâ€™ll create a new script in the versionâ€™s directory with the commands reflecting your schema
changes. Here, we have the required operations to create our posts and comments table, with
all of their columns and constraints. Notice that we have two functions: <code class="docutils literal notranslate"><span class="pre">upgrade</span></code> and
<code class="docutils literal notranslate"><span class="pre">downgrade</span></code>. The first one is used to apply the migration and the second one is used to roll
it back. This is very important because if something goes wrong during the migration,
or if you need to revert to an older version of your application, youâ€™ll be able to do so
without breaking your data.</p>
<p>Finally, you can apply the migrations to your database using the following command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ alembic upgrade head
</pre></div>
</div>
<p>This will run all the migrations that have not yet been applied to your database until the
latest. Itâ€™s interesting to know that, in the process, Alembic creates a table in your database
so that it can remember all the migrations it has applied: this is how it detects which
scripts to run.</p>
</div>
</div>
<div class="section" id="communicating-with-a-sql-database-with-tortoise-orm">
<h2>Communicating with a SQL database with Tortoise ORM<a class="headerlink" href="#communicating-with-a-sql-database-with-tortoise-orm" title="Permalink to this headline">Â¶</a></h2>
<p>When dealing with relational databases, you might wish to abstract away the SQL
concepts and only deal with proper objects from the programming language. Thatâ€™s
the main motivation behind ORM tools. In this section, weâ€™ll examine how to work with Tortoise ORM, which is a modern and asynchronous ORM that fits nicely within a FastAPI project.</p>
<div class="section" id="creating-database-models">
<h3>Creating database models<a class="headerlink" href="#creating-database-models" title="Permalink to this headline">Â¶</a></h3>
<p>The first step is to create the Tortoise model for your entity. This is a Python class whose
attributes represent the columns of your table. This class will provide you static methods
in which to perform queries, such as retrieving or creating data. Moreover, the actual
entities of your database will be instances of this class, giving you access to its data like any
other object. Under the hood, the role of Tortoise is to make the link between this Python
object and the row in the database. Letâ€™s take a look at the definition of our blog post
model in the following example:</p>
<div class="margin sidebar">
<p class="sidebar-title"></p>
<p>You can find the complete list of <a class="reference external" href="https://tortoise-orm.readthedocs.io/en/latest/fields.html">field classes</a> in the official docs.</p>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># chapter6/tortoise/models.py</span>

<span class="k">class</span> <span class="nc">PostTortoise</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">IntField</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">generated</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">publication_date</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">DatetimeField</span><span class="p">(</span><span class="n">null</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span><span class="n">null</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">table</span> <span class="o">=</span> <span class="s2">&quot;posts&quot;</span>
</pre></div>
</div>
<p>Notice that we also have a sub-class called <code class="docutils literal notranslate"><span class="pre">Meta</span></code>, which allows us to set some options for
our table. Here, the table attribute allows us to control the name of the table.</p>
<p>We also define
the corresponding Pydantic models for our post entity. They will be used by FastAPI to
perform data validation and serialization. As you can see in the following example,
we added a <code class="docutils literal notranslate"><span class="pre">Config</span></code> sub-class and set an attribute called <code class="docutils literal notranslate"><span class="pre">orm_mode</span></code>. This option will allow us to transform an ORM object instance into a Pydantic object
instance. This is essential because FastAPI is designed to work with Pydantic models,
not ORM models.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># chapter6/tortoise/models.py</span>

<span class="k">class</span> <span class="nc">PostBase</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">title</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">content</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">publication_date</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Config</span><span class="p">:</span>
        <span class="n">orm_mode</span> <span class="o">=</span> <span class="kc">True</span>


<span class="k">class</span> <span class="nc">PostPartialUpdate</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">title</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">content</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>


<span class="k">class</span> <span class="nc">PostCreate</span><span class="p">(</span><span class="n">PostBase</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">PostDB</span><span class="p">(</span><span class="n">PostBase</span><span class="p">):</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span>
</pre></div>
</div>
<p>Here, we hit what is maybe the most confusing part about working with FastAPI and an
ORM: weâ€™ll have to work with both ORM objects and Pydantic models and find ways to
transform them back and forth.</p>
</div>
<div class="section" id="setting-up-the-tortoise-engine">
<h3>Setting up the Tortoise engine<a class="headerlink" href="#setting-up-the-tortoise-engine" title="Permalink to this headline">Â¶</a></h3>
<p>Now that we have our model ready, we have to configure the Tortoise engine to set the
database connection string and the location of our models. To do this, Tortoise comes
with a utility function for FastAPI that does all the required tasks for you. In particular,
it automatically adds event handlers to open and close the connection at startup and
shutdown; this is something we had to do by hand with SQLAlchemy.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># chapter6/tortoise/app.py</span>

<span class="n">TORTOISE_ORM</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;connections&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="s2">&quot;sqlite://chapter6_tortoise.db&quot;</span><span class="p">},</span>
    <span class="s2">&quot;apps&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;models&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;models&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;chapter6.tortoise.models&quot;</span><span class="p">],</span>
            <span class="s2">&quot;default_connection&quot;</span><span class="p">:</span> <span class="s2">&quot;default&quot;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">},</span>
<span class="p">}</span>

<span class="n">register_tortoise</span><span class="p">(</span>
    <span class="n">app</span><span class="p">,</span>
    <span class="n">config</span><span class="o">=</span><span class="n">TORTOISE_ORM</span><span class="p">,</span>
    <span class="n">generate_schemas</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">add_exception_handlers</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<p>As you can see, we put the main configuration options in a variable named <code class="docutils literal notranslate"><span class="pre">TORTOISE_ORM</span></code>. Letâ€™s review its different fields:</p>
<ul class="simple">
<li><p>The connections key contains a dictionary associating a database alias to
a connection string, which gives access to your database. It follows the standard
convention, as explained in <a class="reference external" href="https://tortoise-orm.readthedocs.io/en/latest/databases.html?highlight=db_url#db-url">the docs</a>. In most projects, youâ€™ll probably have one database named default, but it allows
you to set several databases if needed.</p></li>
</ul>
<ul class="simple">
<li><p>In the apps key, youâ€™ll be able to declare all your modules containing your Tortoise models. The first key just below apps, that is, <code class="docutils literal notranslate"><span class="pre">models</span></code>, will be the prefix with which youâ€™ll be able to refer to the associated models. Note that this name is arbitrarily chosen, but is especially important when defining foreign keys. For example, with this configuration, our <code class="docutils literal notranslate"><span class="pre">PostTortoise</span></code> model can be referred to by the name <code class="docutils literal notranslate"><span class="pre">models.PostTortoise</span></code>. Itâ€™s not the actual path to your module. Underneath it, you have to list all the modules containing your models.
Additionally, we set the corresponding database connection with the alias
we defined earlier.</p></li>
</ul>
<p>Then, we call the <code class="docutils literal notranslate"><span class="pre">register_tortoise</span></code> function thatâ€™ll take care of setting up Tortoise
for FastAPI. Setting <code class="docutils literal notranslate"><span class="pre">generate_schemas</span></code> to <code class="docutils literal notranslate"><span class="pre">True</span></code> will automatically create the tableâ€™s schema
in the database. Otherwise, our database will be empty and we wonâ€™t be able to
insert any rows. While this is useful for testing purposes, in a real-world application, you should
have a proper migration system whose role is to make sure your database schema
is in sync. We do this below.</p>
</div>
<div class="section" id="creating-objects">
<h3>Creating objects<a class="headerlink" href="#creating-objects" title="Permalink to this headline">Â¶</a></h3>
<p>Letâ€™s start by inserting new objects inside our database. The main challenge is to transform
the Tortoise object instance into a Pydantic model.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># chapter6/tortoise/app.py</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/posts&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">PostDB</span><span class="p">,</span> <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_201_CREATED</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">create_post</span><span class="p">(</span><span class="n">post</span><span class="p">:</span> <span class="n">PostCreate</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PostDB</span><span class="p">:</span>
    <span class="n">post_tortoise</span> <span class="o">=</span> <span class="k">await</span> <span class="n">PostTortoise</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="o">**</span><span class="n">post</span><span class="o">.</span><span class="n">dict</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">PostDB</span><span class="o">.</span><span class="n">from_orm</span><span class="p">(</span><span class="n">post_tortoise</span><span class="p">)</span> <span class="c1"># Recall from_orm = True</span>
</pre></div>
</div>
<p>You can see that the implementation is quite straightforward compared to using SQL. Moreover, this operation is natively asynchronous!</p>
</div>
<div class="section" id="getting-and-filtering-objects">
<h3>Getting and filtering objects<a class="headerlink" href="#getting-and-filtering-objects" title="Permalink to this headline">Â¶</a></h3>
<p>Usually, a REST API provides two types of endpoints to read data: one to list objects
and one to get a specific object. This is exactly what weâ€™ll review next! In the following example, you can see how we implemented the endpoint to list objects:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># chapter6/tortoise/app.py</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">get_post_or_404</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PostTortoise</span><span class="p">:</span>
    <span class="k">return</span> <span class="k">await</span> <span class="n">PostTortoise</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/posts&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">list_posts</span><span class="p">(</span><span class="n">pagination</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span><span class="o">=</span><span class="n">Depends</span><span class="p">(</span><span class="n">pagination</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">PostDB</span><span class="p">]:</span>
    <span class="n">skip</span><span class="p">,</span> <span class="n">limit</span> <span class="o">=</span> <span class="n">pagination</span>
    <span class="n">posts</span> <span class="o">=</span> <span class="k">await</span> <span class="n">PostTortoise</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">offset</span><span class="p">(</span><span class="n">skip</span><span class="p">)</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="n">limit</span><span class="p">)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">PostDB</span><span class="o">.</span><span class="n">from_orm</span><span class="p">(</span><span class="n">post</span><span class="p">)</span> <span class="k">for</span> <span class="n">post</span> <span class="ow">in</span> <span class="n">posts</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">results</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/posts/</span><span class="si">{id}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">PostDB</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">get_post</span><span class="p">(</span><span class="n">post</span><span class="p">:</span> <span class="n">PostTortoise</span><span class="o">=</span><span class="n">Depends</span><span class="p">(</span><span class="n">get_post_or_404</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="n">PostDB</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">PostDB</span><span class="o">.</span><span class="n">from_orm</span><span class="p">(</span><span class="n">post</span><span class="p">)</span>
</pre></div>
</div>
<p>The dependency takes the <code class="docutils literal notranslate"><span class="pre">id</span></code> in the path parameter and retrieve a single object from the database that corresponds to this identifier. The <code class="docutils literal notranslate"><span class="pre">get</span></code> method is a convenient shortcut for this: if no matching record is found, it raises the <code class="docutils literal notranslate"><span class="pre">DoesNotExist</span></code> exception. If there is more than one matching record, it raises
<code class="docutils literal notranslate"><span class="pre">MultipleObjectsReturned</span></code>. Remember that we set up Tortoise with
the <code class="docutils literal notranslate"><span class="pre">add_exception_handlers</span></code> option: under the hood, it adds a global handler that
automatically catches <code class="docutils literal notranslate"><span class="pre">DoesNotExist</span></code> and builds a proper 404 error in the console.</p>
</div>
<div class="section" id="updating-and-deleting-objects">
<h3>Updating and deleting objects<a class="headerlink" href="#updating-and-deleting-objects" title="Permalink to this headline">Â¶</a></h3>
<p>For updating and deleting objects the logic is always
the same; we just have to adapt the methods we call on our Tortoise object.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># chapter6/tortoise/app.py</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s2">&quot;/posts/</span><span class="si">{id}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">PostDB</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">update_post</span><span class="p">(</span>
    <span class="n">post_update</span><span class="p">:</span> <span class="n">PostPartialUpdate</span><span class="p">,</span>
    <span class="n">post</span><span class="p">:</span> <span class="n">PostTortoise</span><span class="o">=</span><span class="n">Depends</span><span class="p">(</span><span class="n">get_post_or_404</span><span class="p">)</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PostDB</span><span class="p">:</span>

    <span class="n">post</span><span class="o">.</span><span class="n">update_from_dict</span><span class="p">(</span><span class="n">post_update</span><span class="o">.</span><span class="n">dict</span><span class="p">(</span><span class="n">exclude_unset</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
    <span class="k">await</span> <span class="n">post</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">PostDB</span><span class="o">.</span><span class="n">from_orm</span><span class="p">(</span><span class="n">post</span><span class="p">)</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s2">&quot;/posts/</span><span class="si">{id}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_204_NO_CONTENT</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">delete_post</span><span class="p">(</span><span class="n">post</span><span class="p">:</span> <span class="n">PostTortoise</span><span class="o">=</span><span class="n">Depends</span><span class="p">(</span><span class="n">get_post_or_404</span><span class="p">)):</span>
    <span class="k">await</span> <span class="n">post</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
</pre></div>
</div>
<p>Thatâ€™s almost it for the basics of working with Tortoise ORM. We only covered
the most basic queries, but you can do far more complex things. You can find a thorough
overview of the query language in the official documentation <a class="reference external" href="https://tortoise-orm.readthedocs.io/en/latest/query.html#query-api">here</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>http POST :8000/posts <span class="nv">title</span><span class="o">=</span><span class="s2">&quot;Post #1&quot;</span> <span class="nv">content</span><span class="o">=</span><span class="s2">&quot;Content #1&quot;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Blue">HTTP</span>/<span class=" -Color -Color-Blue">1.1</span> <span class=" -Color -Color-Blue">201</span> <span class=" -Color -Color-Cyan">Created</span>
<span class=" -Color -Color-Cyan">content-length</span>: 103
<span class=" -Color -Color-Cyan">content-type</span>: application/json
<span class=" -Color -Color-Cyan">date</span>: Sun, 06 Mar 2022 09:33:20 GMT
<span class=" -Color -Color-Cyan">server</span>: uvicorn

{
<span class=" -Color -Color-White">    </span>&quot;content&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Yellow">&quot;Content #1&quot;</span>,
<span class=" -Color -Color-White">    </span>&quot;id&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Blue">1</span>,
<span class=" -Color -Color-White">    </span>&quot;publication_date&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Yellow">&quot;2022-03-06T17:33:20.714966+00:00&quot;</span>,
<span class=" -Color -Color-White">    </span>&quot;title&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Yellow">&quot;Post #1&quot;</span>
}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>http POST :8000/posts <span class="nv">title</span><span class="o">=</span><span class="s2">&quot;Post #2&quot;</span> <span class="nv">content</span><span class="o">=</span><span class="s2">&quot;Content #2&quot;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Blue">HTTP</span>/<span class=" -Color -Color-Blue">1.1</span> <span class=" -Color -Color-Blue">201</span> <span class=" -Color -Color-Cyan">Created</span>
<span class=" -Color -Color-Cyan">content-length</span>: 103
<span class=" -Color -Color-Cyan">content-type</span>: application/json
<span class=" -Color -Color-Cyan">date</span>: Sun, 06 Mar 2022 09:33:29 GMT
<span class=" -Color -Color-Cyan">server</span>: uvicorn

{
<span class=" -Color -Color-White">    </span>&quot;content&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Yellow">&quot;Content #2&quot;</span>,
<span class=" -Color -Color-White">    </span>&quot;id&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Blue">2</span>,
<span class=" -Color -Color-White">    </span>&quot;publication_date&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Yellow">&quot;2022-03-06T17:33:29.224391+00:00&quot;</span>,
<span class=" -Color -Color-White">    </span>&quot;title&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Yellow">&quot;Post #2&quot;</span>
}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>http PATCH :8000/posts/1 <span class="nv">content</span><span class="o">=</span><span class="s2">&quot;New Content #1&quot;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Blue">HTTP</span>/<span class=" -Color -Color-Blue">1.1</span> <span class=" -Color -Color-Blue">200</span> <span class=" -Color -Color-Cyan">OK</span>
<span class=" -Color -Color-Cyan">content-length</span>: 107
<span class=" -Color -Color-Cyan">content-type</span>: application/json
<span class=" -Color -Color-Cyan">date</span>: Sun, 06 Mar 2022 09:34:00 GMT
<span class=" -Color -Color-Cyan">server</span>: uvicorn

{
<span class=" -Color -Color-White">    </span>&quot;content&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Yellow">&quot;New Content #1&quot;</span>,
<span class=" -Color -Color-White">    </span>&quot;id&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Blue">1</span>,
<span class=" -Color -Color-White">    </span>&quot;publication_date&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Yellow">&quot;2022-03-06T17:33:20.714966+00:00&quot;</span>,
<span class=" -Color -Color-White">    </span>&quot;title&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Yellow">&quot;Post #1&quot;</span>
}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>http :8000/posts
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Blue">HTTP</span>/<span class=" -Color -Color-Blue">1.1</span> <span class=" -Color -Color-Blue">200</span> <span class=" -Color -Color-Cyan">OK</span>
<span class=" -Color -Color-Cyan">content-length</span>: 213
<span class=" -Color -Color-Cyan">content-type</span>: application/json
<span class=" -Color -Color-Cyan">date</span>: Sun, 06 Mar 2022 09:34:10 GMT
<span class=" -Color -Color-Cyan">server</span>: uvicorn

[
<span class=" -Color -Color-White">    </span>{
<span class=" -Color -Color-White">        </span>&quot;content&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Yellow">&quot;New Content #1&quot;</span>,
<span class=" -Color -Color-White">        </span>&quot;id&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Blue">1</span>,
<span class=" -Color -Color-White">        </span>&quot;publication_date&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Yellow">&quot;2022-03-06T17:33:20.714966+00:00&quot;</span>,
<span class=" -Color -Color-White">        </span>&quot;title&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Yellow">&quot;Post #1&quot;</span>
<span class=" -Color -Color-White">    </span>},
<span class=" -Color -Color-White">    </span>{
<span class=" -Color -Color-White">        </span>&quot;content&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Yellow">&quot;Content #2&quot;</span>,
<span class=" -Color -Color-White">        </span>&quot;id&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Blue">2</span>,
<span class=" -Color -Color-White">        </span>&quot;publication_date&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Yellow">&quot;2022-03-06T17:33:29.224391+00:00&quot;</span>,
<span class=" -Color -Color-White">        </span>&quot;title&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Yellow">&quot;Post #2&quot;</span>
<span class=" -Color -Color-White">    </span>}
]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>http DELETE :8000/posts/2
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Blue">HTTP</span>/<span class=" -Color -Color-Blue">1.1</span> <span class=" -Color -Color-Blue">204</span> <span class=" -Color -Color-Cyan">No Content</span>
<span class=" -Color -Color-Cyan">content-length</span>: 4
<span class=" -Color -Color-Cyan">content-type</span>: application/json
<span class=" -Color -Color-Cyan">date</span>: Sun, 06 Mar 2022 09:34:24 GMT
<span class=" -Color -Color-Cyan">server</span>: uvicorn


</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>http :8000/posts/1
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Blue">HTTP</span>/<span class=" -Color -Color-Blue">1.1</span> <span class=" -Color -Color-Blue">200</span> <span class=" -Color -Color-Cyan">OK</span>
<span class=" -Color -Color-Cyan">content-length</span>: 107
<span class=" -Color -Color-Cyan">content-type</span>: application/json
<span class=" -Color -Color-Cyan">date</span>: Sun, 06 Mar 2022 09:34:31 GMT
<span class=" -Color -Color-Cyan">server</span>: uvicorn

{
<span class=" -Color -Color-White">    </span>&quot;content&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Yellow">&quot;New Content #1&quot;</span>,
<span class=" -Color -Color-White">    </span>&quot;id&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Blue">1</span>,
<span class=" -Color -Color-White">    </span>&quot;publication_date&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Yellow">&quot;2022-03-06T17:33:20.714966+00:00&quot;</span>,
<span class=" -Color -Color-White">    </span>&quot;title&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Yellow">&quot;Post #1&quot;</span>
}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>http :8000/posts/2
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Blue">HTTP</span>/<span class=" -Color -Color-Blue">1.1</span> <span class=" -Color -Color-Blue">404</span> <span class=" -Color -Color-Cyan">Not Found</span>
<span class=" -Color -Color-Cyan">content-length</span>: 34
<span class=" -Color -Color-Cyan">content-type</span>: application/json
<span class=" -Color -Color-Cyan">date</span>: Sun, 06 Mar 2022 09:34:37 GMT
<span class=" -Color -Color-Cyan">server</span>: uvicorn

{
<span class=" -Color -Color-White">    </span>&quot;detail&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Yellow">&quot;Object does not exist&quot;</span>
}
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="id2">
<h3>Adding relationships<a class="headerlink" href="#id2" title="Permalink to this headline">Â¶</a></h3>
<p>Once again, weâ€™ll examine how
to implement comments that are linked to posts. One of the main tasks of Tortoise, and
ORM in general, is to ease the process of working with related entities, by automatically
making the required JOIN queries and instantiating sub-objects.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># chapter6/tortoise_relationship/models.py</span>

<span class="k">class</span> <span class="nc">CommentTortoise</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">IntField</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">generated</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">post</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">ForeignKeyField</span><span class="p">(</span>
        <span class="s2">&quot;models.PostTortoise&quot;</span><span class="p">,</span> 
        <span class="n">related_name</span><span class="o">=</span><span class="s2">&quot;comments&quot;</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    <span class="n">publication_date</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">DatetimeField</span><span class="p">(</span><span class="n">null</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span><span class="n">null</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">table</span> <span class="o">=</span> <span class="s2">&quot;comments&quot;</span>
</pre></div>
</div>
<p>The main point of interest here is the <code class="docutils literal notranslate"><span class="pre">post</span></code> field, which is purposely defined as a foreign
key. The first argument is the reference to the associated model. Notice that we use the
<code class="docutils literal notranslate"><span class="pre">models</span></code> prefix; this is the same one we defined in the Tortoise configuration that we saw
earlier. Additionally, we set the <code class="docutils literal notranslate"><span class="pre">related_name</span></code>. This is a typical and convenient feature
of ORM. By doing this, weâ€™ll be able to get all the comments of a given post simply by
accessing its comments property. The action of querying the related comments, therefore,
becomes completely <em>implicit</em>.</p>
<p>We also define the corresponding Pydantic models:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># chapter6/tortoise_relationship/models.py</span>

<span class="k">class</span> <span class="nc">CommentBase</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">post_id</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">publication_date</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
    <span class="n">content</span><span class="p">:</span> <span class="nb">str</span>

    <span class="k">class</span> <span class="nc">Config</span><span class="p">:</span>
        <span class="n">orm_mode</span> <span class="o">=</span> <span class="kc">True</span>


<span class="k">class</span> <span class="nc">CommentCreate</span><span class="p">(</span><span class="n">CommentBase</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">CommentDB</span><span class="p">(</span><span class="n">CommentBase</span><span class="p">):</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span>
</pre></div>
</div>
<p>Here, you can see that we have defined a <code class="docutils literal notranslate"><span class="pre">post_id</span></code> attribute. This attribute will be used in
the request payload to set the post that we want to attach this new comment to. When you
provide this attribute to Tortoise, it automatically understands that you are referring to the
identifier of the foreign key field, called <code class="docutils literal notranslate"><span class="pre">post</span></code>.</p>
<p>In a REST API, sometimes, it makes sense to automatically retrieve the associated objects
of an entity in one request. Here, weâ€™ll ensure that the comments of a post are returned in
the form of a list along with the post data. To do this, we introduce a new Pydantic model,
<code class="docutils literal notranslate"><span class="pre">PostPublic</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># chapter6/tortoise_relationship/models.py</span>

<span class="k">class</span> <span class="nc">PostPublic</span><span class="p">(</span><span class="n">PostDB</span><span class="p">):</span>
    <span class="n">comments</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">CommentDB</span><span class="p">]</span>

    <span class="nd">@validator</span><span class="p">(</span><span class="s2">&quot;comments&quot;</span><span class="p">,</span> <span class="n">pre</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">fetch_comments</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="c1"># preprocess: convert to list</span>
</pre></div>
</div>
<p>Earlier, we mentioned that thanks to Tortoise, we can retrieve the comments of a post by simply
doing <code class="docutils literal notranslate"><span class="pre">post.comments</span></code>. This is convenient, but this attribute is not directly a list of data:
itâ€™s a query set object. If we donâ€™t do anything, then, when we try to transform the ORM
object into a <code class="docutils literal notranslate"><span class="pre">PostPublic</span></code>, Pydantic will try to parse this query set and fail. However,
calling list on this query set forces it to output the data. That is the purpose of this
validator. Notice that we set it with <code class="docutils literal notranslate"><span class="pre">pre=True</span></code> to make sure itâ€™s called before the built-in
Pydantic validation.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># chapter6/tortoise_relationship/app.py</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/comments&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">CommentDB</span><span class="p">,</span> <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_201_CREATED</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">create_comment</span><span class="p">(</span><span class="n">comment</span><span class="p">:</span> <span class="n">CommentBase</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CommentDB</span><span class="p">:</span>
    
    <span class="c1"># First check if post exists</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">PostTortoise</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">comment</span><span class="o">.</span><span class="n">post_id</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">,</span>
            <span class="n">detail</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Post </span><span class="si">{</span><span class="nb">id</span><span class="si">}</span><span class="s2"> does not exist&quot;</span>
        <span class="p">)</span>
        
    <span class="c1"># Create comment</span>
    <span class="n">comment_tortoise</span> <span class="o">=</span> <span class="k">await</span> <span class="n">CommentTortoise</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="o">**</span><span class="n">comment</span><span class="o">.</span><span class="n">dict</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">CommentDB</span><span class="o">.</span><span class="n">from_orm</span><span class="p">(</span><span class="n">comment_tortoise</span><span class="p">)</span>
</pre></div>
</div>
<p>Most of the logic is very similar to the create post endpoint. The main difference is that
we first check for the existence of the post before proceeding with the comment creation.
Indeed, we want to avoid the foreign key constraint error that could occur at the database
level and show a clear and helpful error message to the end user instead.</p>
<p>As we mentioned earlier, our objective is to output the comments when retrieving a single
post. To do this, we made a small change to the <code class="docutils literal notranslate"><span class="pre">get_post_or_404</span></code>. We also make a few changes on the endpoints for selecting all posts and selecting a single post.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># chapter6/tortoise_relationship/app.py</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">get_post_or_404</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PostTortoise</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">PostTortoise</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span><span class="o">.</span><span class="n">prefetch_related</span><span class="p">(</span><span class="s2">&quot;comments&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span><span class="p">)</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/posts&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">list_posts</span><span class="p">(</span><span class="n">pagination</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">pagination</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">PostPublic</span><span class="p">]:</span>
    <span class="n">skip</span><span class="p">,</span> <span class="n">limit</span> <span class="o">=</span> <span class="n">pagination</span>
    <span class="n">posts</span> <span class="o">=</span> <span class="k">await</span> <span class="n">PostTortoise</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">prefetch_related</span><span class="p">(</span><span class="s2">&quot;comments&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">offset</span><span class="p">(</span><span class="n">skip</span><span class="p">)</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="n">limit</span><span class="p">)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">PostPublic</span><span class="o">.</span><span class="n">from_orm</span><span class="p">(</span><span class="n">post</span><span class="p">)</span> <span class="k">for</span> <span class="n">post</span> <span class="ow">in</span> <span class="n">posts</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">results</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/posts/</span><span class="si">{id}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">PostPublic</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">get_post</span><span class="p">(</span><span class="n">post</span><span class="p">:</span> <span class="n">PostTortoise</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_post_or_404</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="n">PostPublic</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">PostPublic</span><span class="o">.</span><span class="n">from_orm</span><span class="p">(</span><span class="n">post</span><span class="p">)</span>
    
</pre></div>
</div>
<p>For fun, we list all posts along with all its comments. Testing everything:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>http POST :8000/posts <span class="nv">title</span><span class="o">=</span><span class="s2">&quot;Post #1&quot;</span> <span class="nv">content</span><span class="o">=</span><span class="s2">&quot;Hello #1&quot;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Blue">HTTP</span>/<span class=" -Color -Color-Blue">1.1</span> <span class=" -Color -Color-Blue">201</span> <span class=" -Color -Color-Cyan">Created</span>
<span class=" -Color -Color-Cyan">content-length</span>: 101
<span class=" -Color -Color-Cyan">content-type</span>: application/json
<span class=" -Color -Color-Cyan">date</span>: Sun, 06 Mar 2022 12:34:13 GMT
<span class=" -Color -Color-Cyan">server</span>: uvicorn

{
<span class=" -Color -Color-White">    </span>&quot;content&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Yellow">&quot;Hello #1&quot;</span>,
<span class=" -Color -Color-White">    </span>&quot;id&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Blue">1</span>,
<span class=" -Color -Color-White">    </span>&quot;publication_date&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Yellow">&quot;2022-03-06T20:34:14.776126+00:00&quot;</span>,
<span class=" -Color -Color-White">    </span>&quot;title&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Yellow">&quot;Post #1&quot;</span>
}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>http POST :8000/posts <span class="nv">title</span><span class="o">=</span><span class="s2">&quot;Post #2&quot;</span> <span class="nv">content</span><span class="o">=</span><span class="s2">&quot;Hello #2&quot;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Blue">HTTP</span>/<span class=" -Color -Color-Blue">1.1</span> <span class=" -Color -Color-Blue">201</span> <span class=" -Color -Color-Cyan">Created</span>
<span class=" -Color -Color-Cyan">content-length</span>: 101
<span class=" -Color -Color-Cyan">content-type</span>: application/json
<span class=" -Color -Color-Cyan">date</span>: Sun, 06 Mar 2022 12:34:16 GMT
<span class=" -Color -Color-Cyan">server</span>: uvicorn

{
<span class=" -Color -Color-White">    </span>&quot;content&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Yellow">&quot;Hello #2&quot;</span>,
<span class=" -Color -Color-White">    </span>&quot;id&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Blue">2</span>,
<span class=" -Color -Color-White">    </span>&quot;publication_date&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Yellow">&quot;2022-03-06T20:34:17.113035+00:00&quot;</span>,
<span class=" -Color -Color-White">    </span>&quot;title&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Yellow">&quot;Post #2&quot;</span>
}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>http PATCH :8000/posts/1 <span class="nv">content</span><span class="o">=</span><span class="s2">&quot;Hi #1&quot;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Blue">HTTP</span>/<span class=" -Color -Color-Blue">1.1</span> <span class=" -Color -Color-Blue">200</span> <span class=" -Color -Color-Cyan">OK</span>
<span class=" -Color -Color-Cyan">content-length</span>: 98
<span class=" -Color -Color-Cyan">content-type</span>: application/json
<span class=" -Color -Color-Cyan">date</span>: Sun, 06 Mar 2022 12:34:19 GMT
<span class=" -Color -Color-Cyan">server</span>: uvicorn

{
<span class=" -Color -Color-White">    </span>&quot;content&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Yellow">&quot;Hi #1&quot;</span>,
<span class=" -Color -Color-White">    </span>&quot;id&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Blue">1</span>,
<span class=" -Color -Color-White">    </span>&quot;publication_date&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Yellow">&quot;2022-03-06T20:34:14.776126+00:00&quot;</span>,
<span class=" -Color -Color-White">    </span>&quot;title&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Yellow">&quot;Post #1&quot;</span>
}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>http DELETE :8000/posts/2
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Blue">HTTP</span>/<span class=" -Color -Color-Blue">1.1</span> <span class=" -Color -Color-Blue">204</span> <span class=" -Color -Color-Cyan">No Content</span>
<span class=" -Color -Color-Cyan">date</span>: Sun, 06 Mar 2022 12:34:26 GMT
<span class=" -Color -Color-Cyan">server</span>: uvicorn
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>http POST :8000/comments <span class="nv">post_id</span><span class="o">=</span><span class="m">1</span> <span class="nv">content</span><span class="o">=</span><span class="s2">&quot;Comment on Post #1.&quot;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Blue">HTTP</span>/<span class=" -Color -Color-Blue">1.1</span> <span class=" -Color -Color-Blue">201</span> <span class=" -Color -Color-Cyan">Created</span>
<span class=" -Color -Color-Cyan">content-length</span>: 106
<span class=" -Color -Color-Cyan">content-type</span>: application/json
<span class=" -Color -Color-Cyan">date</span>: Sun, 06 Mar 2022 12:34:31 GMT
<span class=" -Color -Color-Cyan">server</span>: uvicorn

{
<span class=" -Color -Color-White">    </span>&quot;content&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Yellow">&quot;Comment on Post #1.&quot;</span>,
<span class=" -Color -Color-White">    </span>&quot;id&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Blue">1</span>,
<span class=" -Color -Color-White">    </span>&quot;post_id&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Blue">1</span>,
<span class=" -Color -Color-White">    </span>&quot;publication_date&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Yellow">&quot;2022-03-06T20:34:31.303506+00:00&quot;</span>
}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>http POST :8000/comments <span class="nv">post_id</span><span class="o">=</span><span class="m">1</span> <span class="nv">content</span><span class="o">=</span><span class="s2">&quot;Another comment on Post #1.&quot;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Blue">HTTP</span>/<span class=" -Color -Color-Blue">1.1</span> <span class=" -Color -Color-Blue">201</span> <span class=" -Color -Color-Cyan">Created</span>
<span class=" -Color -Color-Cyan">content-length</span>: 114
<span class=" -Color -Color-Cyan">content-type</span>: application/json
<span class=" -Color -Color-Cyan">date</span>: Sun, 06 Mar 2022 12:34:37 GMT
<span class=" -Color -Color-Cyan">server</span>: uvicorn

{
<span class=" -Color -Color-White">    </span>&quot;content&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Yellow">&quot;Another comment on Post #1.&quot;</span>,
<span class=" -Color -Color-White">    </span>&quot;id&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Blue">2</span>,
<span class=" -Color -Color-White">    </span>&quot;post_id&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Blue">1</span>,
<span class=" -Color -Color-White">    </span>&quot;publication_date&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Yellow">&quot;2022-03-06T20:34:37.435434+00:00&quot;</span>
}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>http :8000/posts/1
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Blue">HTTP</span>/<span class=" -Color -Color-Blue">1.1</span> <span class=" -Color -Color-Blue">200</span> <span class=" -Color -Color-Cyan">OK</span>
<span class=" -Color -Color-Cyan">content-length</span>: 333
<span class=" -Color -Color-Cyan">content-type</span>: application/json
<span class=" -Color -Color-Cyan">date</span>: Sun, 06 Mar 2022 12:34:39 GMT
<span class=" -Color -Color-Cyan">server</span>: uvicorn

{
<span class=" -Color -Color-White">    </span>&quot;comments&quot;:<span class=" -Color -Color-White"> </span>[
<span class=" -Color -Color-White">        </span>{
<span class=" -Color -Color-White">            </span>&quot;content&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Yellow">&quot;Comment on Post #1.&quot;</span>,
<span class=" -Color -Color-White">            </span>&quot;id&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Blue">1</span>,
<span class=" -Color -Color-White">            </span>&quot;post_id&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Blue">1</span>,
<span class=" -Color -Color-White">            </span>&quot;publication_date&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Yellow">&quot;2022-03-06T20:34:31.303506+00:00&quot;</span>
<span class=" -Color -Color-White">        </span>},
<span class=" -Color -Color-White">        </span>{
<span class=" -Color -Color-White">            </span>&quot;content&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Yellow">&quot;Another comment on Post #1.&quot;</span>,
<span class=" -Color -Color-White">            </span>&quot;id&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Blue">2</span>,
<span class=" -Color -Color-White">            </span>&quot;post_id&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Blue">1</span>,
<span class=" -Color -Color-White">            </span>&quot;publication_date&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Yellow">&quot;2022-03-06T20:34:37.435434+00:00&quot;</span>
<span class=" -Color -Color-White">        </span>}
<span class=" -Color -Color-White">    </span>],
<span class=" -Color -Color-White">    </span>&quot;content&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Yellow">&quot;Hi #1&quot;</span>,
<span class=" -Color -Color-White">    </span>&quot;id&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Blue">1</span>,
<span class=" -Color -Color-White">    </span>&quot;publication_date&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Yellow">&quot;2022-03-06T20:34:14.776126+00:00&quot;</span>,
<span class=" -Color -Color-White">    </span>&quot;title&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Yellow">&quot;Post #1&quot;</span>
}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>http :8000/posts
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Blue">HTTP</span>/<span class=" -Color -Color-Blue">1.1</span> <span class=" -Color -Color-Blue">200</span> <span class=" -Color -Color-Cyan">OK</span>
<span class=" -Color -Color-Cyan">content-length</span>: 335
<span class=" -Color -Color-Cyan">content-type</span>: application/json
<span class=" -Color -Color-Cyan">date</span>: Sun, 06 Mar 2022 12:34:42 GMT
<span class=" -Color -Color-Cyan">server</span>: uvicorn

[
<span class=" -Color -Color-White">    </span>{
<span class=" -Color -Color-White">        </span>&quot;comments&quot;:<span class=" -Color -Color-White"> </span>[
<span class=" -Color -Color-White">            </span>{
<span class=" -Color -Color-White">                </span>&quot;content&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Yellow">&quot;Comment on Post #1.&quot;</span>,
<span class=" -Color -Color-White">                </span>&quot;id&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Blue">1</span>,
<span class=" -Color -Color-White">                </span>&quot;post_id&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Blue">1</span>,
<span class=" -Color -Color-White">                </span>&quot;publication_date&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Yellow">&quot;2022-03-06T20:34:31.303506+00:00&quot;</span>
<span class=" -Color -Color-White">            </span>},
<span class=" -Color -Color-White">            </span>{
<span class=" -Color -Color-White">                </span>&quot;content&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Yellow">&quot;Another comment on Post #1.&quot;</span>,
<span class=" -Color -Color-White">                </span>&quot;id&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Blue">2</span>,
<span class=" -Color -Color-White">                </span>&quot;post_id&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Blue">1</span>,
<span class=" -Color -Color-White">                </span>&quot;publication_date&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Yellow">&quot;2022-03-06T20:34:37.435434+00:00&quot;</span>
<span class=" -Color -Color-White">            </span>}
<span class=" -Color -Color-White">        </span>],
<span class=" -Color -Color-White">        </span>&quot;content&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Yellow">&quot;Hi #1&quot;</span>,
<span class=" -Color -Color-White">        </span>&quot;id&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Blue">1</span>,
<span class=" -Color -Color-White">        </span>&quot;publication_date&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Yellow">&quot;2022-03-06T20:34:14.776126+00:00&quot;</span>,
<span class=" -Color -Color-White">        </span>&quot;title&quot;:<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Yellow">&quot;Post #1&quot;</span>
<span class=" -Color -Color-White">    </span>}
]
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="setting-up-a-database-migration-system-with-aerich">
<h3>Setting up a database migration system with Aerich<a class="headerlink" href="#setting-up-a-database-migration-system-with-aerich" title="Permalink to this headline">Â¶</a></h3>
<p>When you make changes
to your database schema, you want to migrate your existing data in production in a safe
and reproducible manner. In this section, weâ€™ll demonstrate how to install and configure
Aerich, which is a database migration tool from the creators of Tortoise.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ pip install aerich
</pre></div>
</div>
<p>The first thing you need to do is declare the Aerich models in your Tortoise configuration.
Indeed, Aerich stores some migration state information in your database. To do this, add <code class="docutils literal notranslate"><span class="pre">&quot;models&quot;:</span> <span class="pre">[&quot;chapter6.tortoise_relationship.models&quot;,</span> <span class="pre">&quot;aerich.models&quot;]</span></code> in <code class="docutils literal notranslate"><span class="pre">TORTOISE_ORM</span></code>. Start initializing:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ aerich init -t chapter6.tortoise_relationship.app.TORTOISE_ORM
$ aerich init-db
</pre></div>
</div>
<div class="margin sidebar">
<p class="sidebar-title"></p>
<p>âš ï¸ Aerich migration scripts are not cross-database compatible. This is why you should have the same database engine both in local and in production.</p>
<br>
<p>âš ï¸ Always review the generated scripts to make sure they correctly reflect your changes and that you donâ€™t lose data in the process. Test your migrations in a test environment and have fresh and working
backups before running them in production.</p>
</div>
<p>During the life of your project, when you have made changes to your tableâ€™s schema,
youâ€™ll have to generate new migration scripts to reflect the changes. This is done quite
easily using the following command. The <code class="docutils literal notranslate"><span class="pre">--name</span></code> option allows you to set a name for your migration. It will automatically generate a new migration file that reflects your changes.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">aerich</span> <span class="n">migrate</span> <span class="o">--</span><span class="n">name</span> <span class="n">added_new_tables</span>
</pre></div>
</div>
<p>To apply the migrations to your database, simply run the following command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">aerich</span> <span class="n">upgrade</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="conclusion">
<h2>Conclusion<a class="headerlink" href="#conclusion" title="Permalink to this headline">Â¶</a></h2>
<p>As you know, databases are an essential part of every system;
they allow you to save data in a structured way and retrieve it precisely and reliably
thanks to powerful query languages. You are now able to leverage their power in FastAPI for relational databases. Additionally,
youâ€™ve seen the differences between working with and without an ORM to manage
relational databases, and you have also learned about the importance of a good migration
system when working with such databases.
Serious things can now happen: users can send and retrieve data to and from your system.
However, this poses a new challenge to tackle. This data needs to be protected so that
it can remain private and secure. This is exactly what weâ€™ll discuss in the next notebook:
how to authenticate users and set up FastAPI for maximum security.</p>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./drafts/fastapi"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            
                <!-- Previous / next buttons -->
<div class='prev-next-area'>
</div>
            
        </div>
    </div>
    <footer class="footer">
  <p>
    
      By ğ—¥ğ—¼ğ—» ğ— ğ—²ğ—±ğ—¶ğ—»ğ—®. Powered by <a href="https://jupyterbook.org">Jupyter Book</a>.<br/>
    
        &copy; Copyright 2021.<br/>
  </p>
</footer>
</main>


      </div>
    </div>
  
  <script src="../../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>